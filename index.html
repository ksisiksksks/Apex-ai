<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Apex AI - Puter Edition</title>
    
    <script src="https://js.puter.com/v2/"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* CSS KHUSUS BIAR RASA APLIKASI */
        body { 
            font-family: 'Outfit', sans-serif; 
            background-color: #000; 
            color: white; 
            -webkit-tap-highlight-color: transparent; /* Hapus kotak biru pas klik di Android */
            overscroll-behavior-y: none; /* Cegah refresh tarik ke bawah */
        }
        
        /* Hilangkan Scrollbar tapi tetap bisa scroll */
        ::-webkit-scrollbar { width: 0px; }
        
        /* Animasi Halus */
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Chat Bubble Keren */
        .bubble-user { background: #3b82f6; color: white; border-radius: 18px 18px 4px 18px; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3); }
        .bubble-ai { background: #1f2937; color: #e5e7eb; border-radius: 18px 18px 18px 4px; border: 1px solid #374151; }
        
        /* Utilitas */
        .hidden-screen { display: none !important; }
        .center-screen { display: flex; flex-col; align-items: center; justify-content: center; height: 100%; }
    </style>
</head>
<body class="h-[100dvh] flex flex-col overflow-hidden text-sm md:text-base selection:bg-blue-500 selection:text-white">

    <div id="login-screen" class="fixed inset-0 z-50 bg-black flex flex-col items-center justify-center p-6 bg-[url('https://grainy-gradients.vercel.app/noise.svg')]">
        <div class="w-full max-w-sm text-center fade-in bg-black/80 backdrop-blur-xl p-8 rounded-3xl border border-gray-800 shadow-2xl">
            <div class="w-20 h-20 bg-gradient-to-tr from-blue-600 to-purple-600 rounded-2xl mx-auto flex items-center justify-center mb-6 shadow-lg shadow-blue-500/20">
                <i class="fas fa-robot text-4xl text-white"></i>
            </div>
            <h1 class="text-3xl font-bold mb-2">Apex AI</h1>
            <p class="text-gray-400 mb-8 text-sm">Masuk untuk menyimpan chat & history secara permanen.</p>
            
            <button onclick="loginPuter()" class="w-full bg-white text-black font-bold py-4 rounded-xl hover:bg-gray-200 transition active:scale-95 flex items-center justify-center gap-3 shadow-xl">
                <i class="fas fa-sign-in-alt"></i>
                <span>Masuk dengan Puter.js</span>
            </button>
            <p class="text-xs text-gray-600 mt-4">Gratis, Aman, Tanpa Server Sendiri</p>
        </div>
    </div>

    <div id="app-screen" class="hidden-screen flex flex-col h-full relative bg-[#050505]">
        
        <div class="h-16 flex items-center justify-between px-4 border-b border-gray-800 bg-black/90 backdrop-blur z-20 sticky top-0">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-full bg-gray-800 flex items-center justify-center border border-gray-700">
                    <i class="fas fa-user text-xs text-gray-400" id="user-avatar-icon"></i>
                </div>
                <div>
                    <h2 class="font-bold text-sm leading-tight" id="username-display">User</h2>
                    <span class="text-[10px] text-green-500 font-medium flex items-center gap-1">
                        <span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span> Online
                    </span>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="logout()" class="w-9 h-9 flex items-center justify-center rounded-full bg-gray-900 text-red-500 hover:bg-red-900/20 border border-gray-800 transition">
                    <i class="fas fa-power-off text-xs"></i>
                </button>
            </div>
        </div>

        <div id="chat-container" class="flex-1 overflow-y-auto p-4 pb-32 space-y-5 scroll-smooth">
            <div class="h-full flex flex-col items-center justify-center text-gray-700 opacity-50 space-y-3">
                <i class="fas fa-fingerprint text-5xl"></i>
                <p class="text-sm font-medium">Apex AI Siap Membantu</p>
            </div>
        </div>

        <div class="absolute bottom-0 left-0 w-full bg-black/95 border-t border-gray-800 p-3 pb-safe z-30 backdrop-blur">
            <div id="preview-box" class="hidden mb-3 ml-1 relative inline-block">
                <img id="img-preview" src="" class="h-20 rounded-xl border border-gray-700 shadow-2xl object-cover">
                <button onclick="clearImage()" class="absolute -top-2 -right-2 w-6 h-6 bg-red-600 rounded-full flex items-center justify-center text-white text-xs border border-black shadow-sm">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="flex items-end gap-2 max-w-3xl mx-auto bg-gray-900 p-2 rounded-2xl border border-gray-800 shadow-xl">
                <button onclick="document.getElementById('file-upload').click()" class="p-3 text-gray-400 hover:text-blue-500 transition rounded-xl hover:bg-gray-800">
                    <i class="fas fa-image text-xl"></i>
                </button>
                <input type="file" id="file-upload" class="hidden" accept="image/*" onchange="handleFile(this)">

                <textarea id="user-input" rows="1" class="flex-1 bg-transparent text-white placeholder-gray-500 text-sm py-3 focus:outline-none resize-none max-h-32" placeholder="Ketik pesan..."></textarea>
                
                <button onclick="sendMessage()" id="send-btn" class="p-3 bg-blue-600 text-white rounded-xl shadow-lg shadow-blue-600/20 active:scale-95 transition disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-paper-plane text-sm"></i>
                </button>
            </div>
            <p class="text-center text-[10px] text-gray-600 mt-2">Powered by Puter.js (No Server Required)</p>
        </div>
    </div>

    <script>
        // --- KONFIGURASI GLOBAL ---
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const loginScreen = document.getElementById('login-screen');
        const appScreen = document.getElementById('app-screen');
        
        let isSignedIn = false;
        let currentUser = null;
        let currentImageFile = null; // Menyimpan File objek asli

        // --- 1. SISTEM LOGIN (PUTER AUTH) ---
        // Puter.js otomatis cek apakah user sudah login di browser ini
        (async () => {
            if (puter.auth.isSignedIn()) {
                const user = await puter.auth.getUser();
                handleLoginSuccess(user);
            } else {
                loginScreen.classList.remove('hidden-screen');
            }
        })();

        async function loginPuter() {
            try {
                // Ini akan membuka popup resmi Puter.js untuk login/sign up
                const user = await puter.auth.signIn();
                handleLoginSuccess(user);
            } catch (error) {
                alert("Login dibatalkan atau error: " + error);
            }
        }

        function handleLoginSuccess(user) {
            isSignedIn = true;
            currentUser = user;
            
            // Update UI
            document.getElementById('username-display').innerText = user.username || "Pengguna";
            loginScreen.classList.add('hidden-screen');
            appScreen.classList.remove('hidden-screen');
            
            // Muat history (Opsional, Puter punya KV storage kalau mau dikembangkan lagi)
            appendSystemMessage(`Selamat datang kembali, ${user.username}!`);
        }

        function logout() {
            puter.auth.signOut();
            location.reload();
        }

        // --- 2. SISTEM CHAT & UPLOAD ---
        
        // Auto-resize Textarea
        userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        // Kirim pakai Enter
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text && !currentImageFile) return;

            // Bersihkan pesan selamat datang jika ada
            if (chatContainer.querySelector('.fa-fingerprint')) chatContainer.innerHTML = '';

            const userMsgText = text;
            const userMsgImg = currentImageFile; // Simpan referensi file

            // 1. Tampilkan Pesan User di UI (Langsung biar responsif)
            appendMessage('user', userMsgText, userMsgImg ? URL.createObjectURL(userMsgImg) : null);
            
            // Reset Input
            userInput.value = '';
            userInput.style.height = 'auto';
            clearImage();
            
            // 2. Tampilkan Loading
            const loadingId = showLoading();

            try {
                let response;

                // --- LOGIKA UTAMA: TEKS ATAU GAMBAR ---
                if (userMsgImg) {
                    // KASUS 1: ADA GAMBAR (Multimodal)
                    // Puter.js v2 punya fitur chat vision. Kita kirim prompt + attachment.
                    // Jika file gambar ada, kita harus baca dulu atau kirim sebagai bagian prompt (tergantung dukungan library)
                    // Di sini kita pakai trik: Puter AI Chat bisa menerima konteks gambar jika didukung modelnya.
                    
                    // Kita akan baca file sebagai Base64 agar bisa diproses
                    const base64Img = await fileToBase64(userMsgImg);
                    
                    // Kirim ke Puter AI (Menggunakan prompt khusus)
                    // Catatan: Model 'gpt-4o' atau 'claude-3-5-sonnet' di Puter mendukung gambar.
                    response = await puter.ai.chat(userMsgText || "Jelaskan gambar ini", {
                        model: 'gpt-4o', // Model yang support gambar
                        attachments: [userMsgImg] // Fitur baru Puter.js support kirim file langsung
                    });

                } else {
                    // KASUS 2: HANYA TEKS
                    response = await puter.ai.chat(userMsgText);
                }

                removeLoading(loadingId);

                // Ambil teks dari respon Puter
                let aiText = "";
                if (typeof response === 'object' && response.message) {
                    aiText = response.message.content;
                } else {
                    aiText = response.toString();
                }

                appendMessage('ai', aiText);

            } catch (err) {
                removeLoading(loadingId);
                appendSystemMessage("Error: " + err.message);
                console.error(err);
            }
        }

        // --- HELPER FUNCTIONS ---

        function appendMessage(role, text, imgSrc = null) {
            const div = document.createElement('div');
            div.className = `flex gap-3 mb-6 w-full ${role === 'user' ? 'flex-row-reverse' : ''}`;
            
            let avatar = role === 'ai' 
                ? `<div class="w-8 h-8 rounded-lg bg-gray-800 flex items-center justify-center shrink-0 border border-gray-700"><i class="fas fa-robot text-white text-xs"></i></div>`
                : ''; // User gak perlu avatar biar bersih

            let imgHTML = imgSrc ? `<img src="${imgSrc}" class="rounded-xl mb-3 max-w-[240px] border border-white/10 shadow-lg block">` : '';
            
            let bubbleClass = role === 'ai' ? 'bubble-ai' : 'bubble-user';
            
            // Parse Markdown hanya untuk AI
            let contentHTML = role === 'ai' ? marked.parse(text) : text.replace(/\n/g, '<br>');

            div.innerHTML = `
                ${role === 'ai' ? avatar : ''}
                <div class="${bubbleClass} p-3.5 px-5 text-sm max-w-[85%] leading-relaxed shadow-sm">
                    ${imgHTML}
                    <div class="${role === 'ai' ? 'prose prose-invert prose-sm' : ''}">${contentHTML}</div>
                </div>
            `;
            
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        function appendSystemMessage(text) {
            const div = document.createElement('div');
            div.className = "w-full text-center my-4";
            div.innerHTML = `<span class="text-xs text-gray-500 bg-gray-900/50 px-3 py-1 rounded-full border border-gray-800">${text}</span>`;
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        function showLoading() {
            const id = 'load-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = 'flex gap-3 mb-4';
            div.innerHTML = `
                <div class="w-8 h-8 rounded-lg bg-gray-800 flex items-center justify-center shrink-0 border border-gray-700"><i class="fas fa-robot text-white text-xs"></i></div>
                <div class="bubble-ai p-3 flex items-center gap-2">
                    <span class="w-2 h-2 bg-gray-500 rounded-full animate-pulse"></span>
                    <span class="w-2 h-2 bg-gray-500 rounded-full animate-pulse delay-75"></span>
                    <span class="w-2 h-2 bg-gray-500 rounded-full animate-pulse delay-150"></span>
                </div>`;
            chatContainer.appendChild(div);
            scrollToBottom();
            return id;
        }

        function removeLoading(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // --- FILE HANDLING ---
        function handleFile(input) {
            const file = input.files[0];
            if (file) {
                currentImageFile = file;
                // Tampilkan preview
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('img-preview').src = e.target.result;
                    document.getElementById('preview-box').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        function clearImage() {
            currentImageFile = null;
            document.getElementById('file-upload').value = '';
            document.getElementById('preview-box').classList.add('hidden');
        }
        
        // Helper ubah file ke Base64 (untuk backup logic)
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
    </script>
</body>
</html>
